<!DOCTYPE html>
<html>
<head>
    <title>Pàgina transcendental - Login</title>
    <link rel="stylesheet" href="estil.css">
    <script src="https://alcdn.msauth.net/browser/2.38.2/js/msal-browser.min.js"></script>
</head>
<body>
    <h1>Pàgina transcendental</h1>
    <p>Inicia sessió per continuar:</p>
    <button id="login-btn">Sign in with Microsoft - FVM</button>
    <p id="usuari-nom"></p>
    <script>
        const isLocalhost = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1";
        const msalConfig = {
            auth: {
                clientId: 'e0ff9f23-e000-4eba-884c-e79559551a47',
                redirectUri: isLocalhost
                    ? 'http://localhost:5500/'
                    : 'https://vinner21.github.io/projecte_web/',
            },
            system: {
                allowRedirectInIframe: true
            },
            cache: {
                cacheLocation: "sessionStorage",
                storeAuthStateInCookie: false
            }
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);

        // Comprova si hi ha algun compte MSAL actiu i actualitza sessionStorage si cal
        let account = null;
        const allAccounts = msalInstance.getAllAccounts();
        if (allAccounts.length > 0) {
            account = allAccounts[0];
            msalInstance.setActiveAccount(account);
            sessionStorage.setItem('usuariMSAL', JSON.stringify(account));
        }

        // Mostra el nom de l'usuari si ja està logat, o un missatge si no ho està
        const user = JSON.parse(sessionStorage.getItem('usuariMSAL'));
        if (user && user.name) {
            document.getElementById('usuari-nom').textContent = `Sessió iniciada com: ${user.name}`;
        } else {
            document.getElementById('usuari-nom').textContent = "No hi ha cap sessió iniciada.";
        }

        document.getElementById('login-btn').onclick = function() {
            msalInstance.loginPopup({
                scopes: ["openid", "profile", "email", "User.Read"]
            }).then(response => {
                let account = response.account;
                if (!account) {
                    const allAccounts = msalInstance.getAllAccounts();
                    if (allAccounts.length > 0) {
                        account = allAccounts[0];
                        msalInstance.setActiveAccount(account);
                    }
                } else {
                    msalInstance.setActiveAccount(account);
                }
                sessionStorage.setItem('usuariMSAL', JSON.stringify(account));
                window.location.href = 'usuari.html';
            }).catch(error => {
                alert('Error d\'autenticació: ' + error.message);
            });
        };
    </script>
</body>
</html>